# 1Panel Docker Compose 编排文件
# 适用于1Panel面板的Docker Compose配置
# 注意：使用外部网络 1panel-network，所有数据存储在 /data/mem0 目录

version: '3.8'

services:
  # Mem0 API 服务
  mem0-api:
    image: mem0-api:latest
    container_name: mem0-api
    restart: unless-stopped
    ports:
      - "8888:8000"
    # 内存限制（如果 1Panel 支持）
    mem_limit: 2g
    mem_reservation: 512m
    environment:
      # ==================== LLM 配置 ====================
      # 必需：配置您的LLM API密钥
      OPENAI_API_KEY: ${OPENAI_API_KEY:-your-openai-api-key-here}
      # 可选：配置OpenAI API Base URL（用于使用兼容OpenAI API的服务，如Azure OpenAI、OpenRouter等）
      # 默认值：https://api.openai.com/v1
      # 示例：
      #   - Azure OpenAI: https://your-resource.openai.azure.com/
      #   - OpenRouter: https://openrouter.ai/api/v1
      #   - 其他兼容服务: https://api.example.com/v1
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      # 可选：配置OpenAI模型（默认：gpt-4.1-nano-2025-04-14）
      # 建议使用支持中文的模型，如：gpt-4、gpt-4-turbo、gpt-3.5-turbo
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4.1-nano-2025-04-14}
      # 可选：配置自定义事实提取提示词（用于控制记忆处理行为）
      # 如果希望保持中文记忆不被翻译，可以设置：
      # "请保持记忆内容的原始语言，不要将中文翻译为英文。如果输入是中文，输出也应该是中文。"
      CUSTOM_FACT_EXTRACTION_PROMPT: ${CUSTOM_FACT_EXTRACTION_PROMPT:-}
      # ==================== 数据库配置 ====================
      # PostgreSQL 配置（使用 pgvector 扩展）
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: mem0
      POSTGRES_USER: mem0
      POSTGRES_PASSWORD: mem0password
      POSTGRES_COLLECTION_NAME: memories
      # ==================== 图数据库配置 ====================
      # Neo4j 配置
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: mem0graph
      # ==================== 历史数据库配置 ====================
      HISTORY_DB_PATH: /app/history/history.db
      # ==================== CORS 配置 ====================
      # 允许的跨域源（用逗号分隔多个源）
      # 默认包含常见的本地和服务器地址
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:4000,http://192.168.66.11:3000,http://192.168.66.11:4000}
    depends_on:
      postgres:
        condition: service_started
      neo4j:
        condition: service_started
    volumes:
      - /data/mem0/history:/app/history
      - /data/mem0/logs:/app/logs
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"

  # Mem0 WebUI 服务（基于 OpenMemory UI，适配 Mem0 API）
  mem0-webui:
    image: mem0-webui:latest
    container_name: mem0-webui
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # WebUI 通过容器名访问 API
      NEXT_PUBLIC_API_URL: http://mem0-api:8000
      # 可选：配置默认用户 ID（默认为 "user"）
      # 所有通过 WebUI 创建的记忆将使用此用户 ID
      NEXT_PUBLIC_USER_ID: ${NEXT_PUBLIC_USER_ID:-user}
    depends_on:
      - mem0-api
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"

  # PostgreSQL 关系数据库（使用带 pgvector 扩展的镜像）
  # 注意：向量数据也存储在此数据库中
  postgres:
    image: pgvector/pgvector:0.8.1-pg17-trixie
    container_name: mem0_postgres
    restart: unless-stopped
    ports:
      - "8432:5432"
    environment:
      POSTGRES_USER: mem0
      POSTGRES_PASSWORD: mem0password
      POSTGRES_DB: mem0
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - /data/mem0/postgres:/var/lib/postgresql/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"

  # Neo4j 图数据库
  neo4j:
    image: neo4j:latest
    container_name: mem0_neo4j
    restart: unless-stopped
    ports:
      - "8474:7474"  # HTTP
      - "8687:7687"  # Bolt
    environment:
      NEO4J_AUTH: neo4j/mem0graph
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 2G
    volumes:
      - /data/mem0/neo4j/data:/data
      - /data/mem0/neo4j/logs:/logs
      - /data/mem0/neo4j/import:/var/lib/neo4j/import
      - /data/mem0/neo4j/plugins:/plugins
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"

networks:
  1panel-network:
    external: true

