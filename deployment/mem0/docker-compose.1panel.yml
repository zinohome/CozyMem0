# 1Panel Docker Compose 编排文件
# 适用于1Panel面板的Docker Compose配置
# 注意：使用外部网络 1panel-network，所有数据存储在 /data/mem0 目录

version: '3.8'

services:
  # Mem0 API 服务
  mem0-api:
    image: mem0-api:latest
    container_name: mem0-api
    restart: unless-stopped
    ports:
      - "8888:8000"
    # 内存限制（如果 1Panel 支持）
    mem_limit: 2g
    mem_reservation: 512m
    environment:
      # ==================== LLM 配置 ====================
      # 必需：配置您的LLM API密钥
      - OPENAI_API_KEY=${OPENAI_API_KEY:-your-openai-api-key-here}
      # ==================== 数据库配置 ====================
      # PostgreSQL 配置（使用 pgvector 扩展）
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=mem0
      - POSTGRES_USER=mem0
      - POSTGRES_PASSWORD=mem0password
      - POSTGRES_COLLECTION_NAME=memories
      # ==================== 图数据库配置 ====================
      # Neo4j 配置
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=mem0graph
      # ==================== 历史数据库配置 ====================
      - HISTORY_DB_PATH=/app/history/history.db
    depends_on:
      postgres:
        condition: service_started
      neo4j:
        condition: service_started
    volumes:
      - /data/mem0/history:/app/history
      - /data/mem0/logs:/app/logs
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"

  # PostgreSQL 关系数据库（使用带 pgvector 扩展的镜像）
  # 注意：向量数据也存储在此数据库中
  postgres:
    image: pgvector/pgvector:0.8.1-pg17-trixie
    container_name: mem0_postgres
    restart: unless-stopped
    ports:
      - "8432:5432"
    environment:
      - POSTGRES_USER=mem0
      - POSTGRES_PASSWORD=mem0password
      - POSTGRES_DB=mem0
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - /data/mem0/postgres:/var/lib/postgresql/data
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-d", "mem0", "-U", "mem0"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Neo4j 图数据库
  neo4j:
    image: neo4j:latest
    container_name: mem0_neo4j
    restart: unless-stopped
    ports:
      - "8474:7474"  # HTTP
      - "8687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/mem0graph
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
    volumes:
      - /data/mem0/neo4j/data:/data
      - /data/mem0/neo4j/logs:/logs
      - /data/mem0/neo4j/import:/var/lib/neo4j/import
      - /data/mem0/neo4j/plugins:/plugins
    networks:
      - 1panel-network
    labels:
      createdBy: "Apps"
    healthcheck:
      test: wget http://localhost:7687 || exit 1
      interval: 1s
      timeout: 10s
      retries: 20
      start_period: 90s

networks:
  1panel-network:
    external: true

