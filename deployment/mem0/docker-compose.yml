# Docker Compose 编排文件
# 适用于本地开发和测试环境
# 注意：使用内部网络 mem0-network，数据存储在 Docker volumes

version: '3.8'

services:
  # Mem0 API 服务
  mem0-api:
    image: mem0-api:latest
    container_name: mem0-api
    restart: unless-stopped
    ports:
      - "8888:8000"
    env_file:
      - .env
    environment:
      # ==================== LLM 配置 ====================
      # 必需：配置您的LLM API密钥
      - OPENAI_API_KEY=${OPENAI_API_KEY:-your-openai-api-key-here}
      # 可选：配置OpenAI API Base URL（用于使用兼容OpenAI API的服务，如Azure OpenAI、OpenRouter等）
      # 默认值：https://api.openai.com/v1
      # 示例：
      #   - Azure OpenAI: https://your-resource.openai.azure.com/
      #   - OpenRouter: https://openrouter.ai/api/v1
      #   - 其他兼容服务: https://api.example.com/v1
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      # 可选：配置OpenAI模型（默认：gpt-4.1-nano-2025-04-14）
      # 建议使用支持中文的模型，如：gpt-4、gpt-4-turbo、gpt-3.5-turbo
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4.1-nano-2025-04-14}
      # 可选：配置自定义事实提取提示词（用于控制记忆处理行为）
      # 如果希望保持中文记忆不被翻译，可以设置：
      # "请保持记忆内容的原始语言，不要将中文翻译为英文。如果输入是中文，输出也应该是中文。"
      - CUSTOM_FACT_EXTRACTION_PROMPT=${CUSTOM_FACT_EXTRACTION_PROMPT:-}
      # ==================== 向量数据库配置 ====================
      # Qdrant 配置（专用向量数据库，高性能）
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION_NAME=memories
      # ==================== 历史数据库配置 ====================
      - HISTORY_DB_PATH=/app/history/history.db
      # ==================== CORS 配置 ====================
      # 允许的跨域源（用逗号分隔多个源）
      # 默认包含常见的本地和服务器地址
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:4000,http://192.168.66.11:3000,http://192.168.66.11:4000}
    depends_on:
      qdrant:
        condition: service_started  # 等待 Qdrant 服务启动
    volumes:
      - mem0_history:/app/history
    networks:
      - mem0-network

  # Mem0 WebUI 服务（基于 OpenMemory UI，适配 Mem0 API）
  mem0-webui:
    image: mem0-webui:latest
    container_name: mem0-webui
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # WebUI 通过容器名访问 API
      - NEXT_PUBLIC_API_URL=http://mem0-api:8000
      # 可选：配置默认用户 ID（默认为 "user"）
      # 所有通过 WebUI 创建的记忆将使用此用户 ID
      - NEXT_PUBLIC_USER_ID=${NEXT_PUBLIC_USER_ID:-user}
    depends_on:
      mem0-api:
        condition: service_started
    networks:
      - mem0-network

  # Qdrant 向量数据库（专用向量数据库，高性能）
  qdrant:
    image: qdrant/qdrant:v1.15
    container_name: mem0_qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - mem0_qdrant_data:/qdrant/storage
    networks:
      - mem0-network

volumes:
  mem0_history:
  mem0_qdrant_data:

networks:
  mem0-network:
    driver: bridge

