# 15 轮完整心理咨询 POC 使用指南

## 📋 概述

这是一个完整的 15 轮心理咨询对话演示，展示了完整记忆框架（LLM + kb_psyc + Memobase + Mem0）在深度咨询场景中的应用。

## 🎯 POC 特点

### 会话设计

- **15 轮深度对话**：从初次访谈到咨询结束的完整流程
- **多维度困扰**：学业压力、人际关系、情绪调节、自我认同
- **渐进式成长**：从问题探索 → 认知重构 → 行为改变 → 获得进步
- **真实场景**：基于真实青少年心理咨询案例设计

### 记忆系统展示

| 记忆系统 | 作用 | 示例 |
|----------|------|------|
| **Memobase 用户画像** | 提供持久化的用户基本信息 | 年龄、性格、学校、主要困扰 |
| **Mem0 会话记忆** | 跨轮次记忆关键事件和进展 | 食堂事件、作息计划、社交练习、成绩进步 |
| **Cognee 知识库** | 提供心理咨询专业知识 | 初次访谈、认知重构、行为改变、青少年发展 |

## 🚀 快速开始

### 前提条件

1. **POC 服务正在运行**

```bash
# 在 conversational-agent-poc 目录下
./start_poc.sh
```

2. **已准备基础数据**（江小婉的用户画像）

```bash
# 如果还没准备，先运行：
python3 prepare_psychology_poc.py
```

### 运行 15 轮 POC

```bash
# 在 conversational-agent-poc 目录下
python3 run_full_15rounds_poc.py
```

### 执行流程

```
1. 📖 加载会话脚本 (session_full_15rounds.json)
2. 📊 显示会话信息（用户、轮数、知识库等）
3. ⏸️  等待用户确认（按 Enter 键）
4. 🔄 逐轮执行对话（15 轮）
   - 显示用户消息
   - 显示期望行为
   - 调用 AI 生成回复
   - 显示记忆系统使用情况
   - 显示 AI 回复
5. 📊 生成执行总结和统计
6. 💾 保存完整结果到 JSON 文件
```

## 📊 输出示例

### 对话过程

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💬 第 1/15 轮对话
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎯 本轮期望行为:
  • 表达欢迎和接纳
  • 建立信任关系
  • 温和地邀请她分享具体困扰
  • 避免过早给建议

⏳ 正在调用 AI...
✅ 响应耗时: 5.23 秒

👧 江小婉:
  老师你好...我是江小婉，朋友推荐我来找你聊聊。最近压力真的好大，感觉自己快撑不住了...

📊 记忆系统使用情况:
  👤 用户画像: 7 个字段
     示例: ['name', 'age', 'gender']
  🧠 会话记忆: 0 条
  📚 专业知识: 2 条
     片段: # 咨询流程和规范\n\n## 一、初次访谈\n\n### 1.1 初次访谈的目标...

🧑‍⚕️ 陈老师:
  小婉，你好！很高兴你能来找我聊聊。首先，我想让你知道，这里是一个安全的空间...
```

### 执行总结

```
════════════════════════════════════════════════════════════════════════════════
                              📊 POC 执行总结
════════════════════════════════════════════════════════════════════════════════

✅ 成功轮数: 15/15
❌ 失败轮数: 0/15
⏱️  总耗时: 87.34 秒
📊 平均响应时间: 5.82 秒/轮

💾 结果已保存: psychology_results/full_15rounds_poc_20251218_195234.json

════════════════════════════════════════════════════════════════════════════════
                          📋 记忆系统使用分析
════════════════════════════════════════════════════════════════════════════════

👤 用户画像使用:
   平均: 7.0 个字段/轮
   范围: 7 - 7

🧠 会话记忆使用:
   平均: 5.3 条/轮
   范围: 0 - 7
   趋势: 递增 (首轮: 0, 末轮: 7)

📚 专业知识使用:
   平均: 2.0 条/轮
   范围: 2 - 2
```

## 📂 输出文件

### 结果 JSON 文件

位置：`psychology_results/full_15rounds_poc_YYYYMMDD_HHMMSS.json`

包含：
- 会话元信息（session_info）
- 用户画像（user_profile）
- 执行统计（总耗时、成功轮数等）
- 每轮详细结果：
  - 用户消息
  - AI 回复
  - 记忆系统上下文（用户画像、会话记忆、专业知识）
  - 响应时间
  - 时间戳

### 文件结构

```json
{
  "session_info": { ... },
  "user_profile": { ... },
  "execution_time": "2025-12-18T19:52:34",
  "total_elapsed_seconds": 87.34,
  "total_rounds": 15,
  "successful_rounds": 15,
  "rounds": [
    {
      "round": 1,
      "user_message": "...",
      "ai_response": "...",
      "context": {
        "user_profile": { ... },
        "session_memories": [ ... ],
        "knowledge": [ ... ]
      },
      "elapsed_seconds": 5.23,
      "timestamp": "..."
    },
    ...
  ]
}
```

## 🔍 会话内容设计

### 对话轨迹

| 轮次 | 阶段 | 主题 | 目的 |
|------|------|------|------|
| 1-3 | 建立关系 | 初次访谈、压力来源探索 | 建立信任、全面了解困扰 |
| 4-6 | 深入探索 | 人际关系、焦虑症状 | 识别认知模式和情绪困扰 |
| 7-9 | 讨论策略 | 学习方法、过度学习 | 建立改变动机、讨论具体方法 |
| 10-12 | 认知重构 | 时间管理、社交技能 | 制定计划、挑战负性认知 |
| 13-15 | 巩固成长 | 进步反馈、咨询总结 | 强化改变、建立自信 |

### 关键情节

- **Round 5**：食堂孤独体验（重要负性事件，后续多次回溯）
- **Round 9**：识别过度学习恶性循环（转折点）
- **Round 10**：制定具体作息和学习计划（行动开始）
- **Round 13**：社交突破（微笑打招呼成功）
- **Round 14**：多方面进步反馈（成绩、社交、情绪）
- **Round 15**：咨询总结，建立持续成长信心

## 🎯 预期效果

### 记忆系统展示

1. **Memobase**：贯穿全程的用户画像（江小婉 15 岁、内向、完美主义等）
2. **Mem0**：会话记忆逐轮累积（0条 → 7条），关键事件被持续回顾
3. **Cognee**：每轮根据对话内容检索相关心理学知识（初次访谈、认知重构、行为改变等）

### 咨询效果

- 从"快撑不住了"到"有力量去面对"
- 从学业焦虑到获得 92 分进步
- 从社交孤立到主动打招呼、一起吃饭
- 从睡眠困扰到规律作息
- 自我效能感和掌控感显著提升

## 💡 使用建议

1. **首次运行**：仔细观察每轮的记忆系统使用情况
2. **对比测试**：可以修改 `user_id` 测试不同组（baseline、kb_only）的效果差异
3. **性能监控**：关注响应时间，平均 5-6 秒/轮为正常范围
4. **数据分析**：运行后可用 `analyze_psychology_results.py` 进一步分析

## 🐛 常见问题

### Q1: 执行中断怎么办？

A: 结果会保存到最后一次成功的轮次。可以查看 JSON 文件的 `successful_rounds` 和 `failed_rounds`。

### Q2: 响应时间太长？

A: 检查是否使用了 CHUNKS 模式（快）还是 GRAPH_COMPLETION 模式（慢）。查看服务日志：

```bash
# 在 start_poc.sh 的终端查看
🚀 尝试 CHUNKS 模式...
✅ CHUNKS 模式成功  ← 快速模式
# 或
⚠️ 降级到 GRAPH_COMPLETION  ← 慢速模式
```

### Q3: 会话记忆没有递增？

A: 检查 Mem0 服务是否正常运行，以及保存操作是否成功（查看日志中的 "Mem0 memory saved"）。

### Q4: 想要修改对话内容？

A: 编辑 `psychology_sessions/session_full_15rounds.json`，修改 `conversation` 数组中的 `user_message` 和 `expected_behavior`。

## 📈 后续步骤

1. **查看详细结果**：

```bash
cat psychology_results/full_15rounds_poc_YYYYMMDD_HHMMSS.json | jq .
```

2. **生成对比报告**（如果有多组测试）：

```bash
python3 analyze_psychology_results.py
```

3. **交互式测试**：

```bash
python3 chat_with_xiaowan.py
```

## 📝 注意事项

- ⚠️ 确保 POC 服务正在运行（`./start_poc.sh`）
- ⚠️ 确保已准备用户数据（`prepare_psychology_poc.py`）
- ⚠️ 执行时间约 2-3 分钟，请耐心等待
- ⚠️ 避免同时运行多个 POC 脚本（会话 ID 冲突）

## 🎉 成功标志

- ✅ 15/15 轮全部成功
- ✅ 会话记忆从 0 递增到 5-7 条
- ✅ 每轮都有相关专业知识检索
- ✅ AI 回复符合心理咨询专业规范
- ✅ 对话体现出咨询进程和来访者成长

---

**祝测试顺利！** 🎊
